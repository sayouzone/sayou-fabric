name: Publish Python Packages to PyPI

on:
  push:
    tags:
      - '*-v*'

jobs:
  build-and-publish:
    name: Build and publish package from tag
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install build tools
        run: pip install build

      - name: Parse package name and version from tag
        id: parse_tag
        run: |
          TAG_NAME="${{ github.ref_name }}"
          PACKAGE_NAME=$(echo $TAG_NAME | rev | cut -d'-' -f2- | rev)
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          PACKAGE_VERSION=$(echo $TAG_NAME | rev | cut -d'-' -f1 | rev | cut -c 2-)
          echo "Deploying $PACKAGE_NAME version $PACKAGE_VERSION"

      - name: Detect package directory
        id: detect_dir
        run: |
          PKG="${{ steps.parse_tag.outputs.package_name }}"
          if [ -d "packages/$PKG" ]; then
            echo "package_dir=packages/$PKG" >> "$GITHUB_OUTPUT"
            echo "✅ Found in packages/$PKG"
          elif [ -d "packages-dev/$PKG" ]; then
            echo "package_dir=packages-dev/$PKG" >> "$GITHUB_OUTPUT"
            echo "✅ Found in packages-dev/$PKG"
          else
            echo "❌ Error: Package not found in packages/ or packages-dev/"
            echo "Checked: $(ls -d packages* || true)"
            exit 1
          fi

      - name: Build ${{ steps.parse_tag.outputs.package_name }}
        run: |
          echo "Building from: ${{ steps.detect_dir.outputs.package_dir }}"
          cd ${{ steps.detect_dir.outputs.package_dir }}
          python -m build

      - name: Publish ${{ steps.parse_tag.outputs.package_name }} to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages_dir: ${{ steps.detect_dir.outputs.package_dir }}/dist/